---
title: "Analyze ADH_10 random forest models"
author: "Allison R. Mason"
date: "2024-02-29"
output: html_document
---

## Overview

This markdown document contains all code to reproduce analyses of random forest models (/scripts/PMI_RF_5000_ADH.Rmd) in the publication XXX. 

```{r setup, include=FALSE}
set.seed(4)

library(readxl)
library(phyloseq)
library(tidyverse)
library(ranger)
library(randomForest)
library(Metrics)
library(here)
library(cowplot)
library(ggpubr)
library(broom)
library(RColorBrewer)

colpalette2= c("khaki3","steelblue3","orange","chocolate","aquamarine4","plum3","black","mediumpurple4","violetred3","brown4","chartreuse3","lavenderblush4","lightpink","mediumpurple3","lightcyan1","palegreen4","red1","wheat4","papayawhip","tomato3","gold1")
```

## Load the data
```{r, include = FALSE}
#load the datasets:
all_rf_results = readRDS(here("Mason_SoilMicrobe-PMI_XXXXX_2023/data/all_rf_results.RDS"))
```

```{r, include=FALSE}
# extract summary table
rf_summary <- function(rf) {
  
  rf@optimal_model_results$summary
}

# get all summary tables
all_rf_summary <- all_rf_results %>%
  map(rf_summary)

mean_values <- all_rf_summary %>% map(apply, 2, mean) %>%
  map(t) %>%
  map(as.data.frame) %>%
  list_rbind(names_to = "model") %>%
  mutate(taxonomy = if_else(str_detect(model, "bact_ITS"), "16S-ITS", str_split_i(model, "_", 1)),
         tax_level = if_else(str_detect(model, "bact_ITS"), str_split_i(model, "_", 3), str_split_i(model, "_", 2)),
         tax_level = recode(tax_level, "otu" = "OTU",
                            "order" = "Order",
                            "class" = "Class",
                            "phylum" = "Phylum",
                            "phlyum" = "Phylum"),
         taxonomy = recode(taxonomy, "bact" = "16S"),
         env = if_else(str_detect(model, "noenv"), "no", "yes"))
  

# writexl::write_xlsx(mean_values, here::here("data/all_rf_mean_results.xlxs"))
```


## Summarize model performace

MAE for all models ranged from `r round(min(mean_values$MAE), 4)` to `r round(max(mean_values$MAE), 4)`, while $r^2$ ranged from `r round(min(mean_values$r_squared), 4)` to `r round(max(mean_values$r_squared), 4)`.

```{r, include=FALSE}
get_MAE <- function(df) {
  df$MAE
}

std_err <- function(data) {
  sd(data) / sqrt(length(data))
}

all_MAE <- all_rf_summary %>% map_df(get_MAE) 
all_MAE_se <- all_MAE %>% 
  map_df(std_err) %>%
  t() %>%
  as.data.frame() %>%
  rename(SE = V1) %>%
  mutate(model = rownames(.))
  

mae_barplot <- mean_values %>%
  left_join(all_MAE_se, by = "model") %>%
  ggplot(aes(x = factor(tax_level, ordered = TRUE, levels = c("Phylum", "Class", "Order", "OTU")), y = MAE, group = env, fill = env)) +
  geom_bar(stat = "identity", color = "black", position = position_dodge()) +
  geom_errorbar(aes(ymin = MAE - SE, ymax = MAE + SE), width = .2, position = position_dodge(.9)) +
  scale_y_continuous(expand = expansion(mult = c(0,0))) +
  coord_cartesian(ylim = c(750, 1000)) + 
  scale_fill_manual(values=c('#999999','#E69F00')) +
  facet_wrap(~ taxonomy) + 
  labs(x = "Taxonomic Level",
       y = "Mean Absolute Error (MAE)",
       fill = "Model Includes\nEnvironmental\nParameters") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = "bottom",
        strip.background = element_rect(fill = "white"))

```

```{r, echo=FALSE, warning=FALSE}
mae_barplot
```


```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig1.tiff"), units = "in", width = 6.5, height = 4, res = 300)
mae_barplot
```

```{r, include=FALSE, eval=FALSE}
mean_values %>%
  arrange(MAE) %>%
  # rename()
  # knitr::kable(., digits = 3, col.names = c("Model name", "OOB MSE", "RMSE", "MAE", "$r^2$", "Marker", "Taxonomic Level", "Enironmental parameters"), escape = FALSE) %>%
  kableExtra::kbl(., digits = 3, col.names = c("Model name", "OOB MSE", "RMSE", "MAE", "$r^2$", "Marker", "Taxonomic Level", "Enironmental parameters"), booktabs = TRUE) # %>%
  # kableExtra::kable_classic() %>%
  # kableExtra::save_kable(., file = here::here("figures/SupTable1.png"))

# pdf(file = here::here("figures/SupTable1.pdf"))
```


### Best 10 overall performing models:

```{r, echo=FALSE}
mean_values %>%
  slice_min(order_by = MAE, n = 10) %>%
  knitr::kable(., caption = "Top 10 as chosen by lowest MAE")
```

```{r, echo=FALSE}
mean_values %>%
  slice_max(order_by = r_squared, n = 10) %>%
  knitr::kable(., caption = "Top 10 as chosen by highest $r^2$")
```

```{r, include=FALSE}
n_16S_top_10 <- mean_values %>% slice_min(order_by = MAE, n = 10) %>% count(taxonomy) %>% filter(taxonomy == "16S") %>% pull(n)
n_16S_ITS_top_10 <- mean_values %>% slice_min(order_by = MAE, n = 10) %>% count(taxonomy) %>% filter(taxonomy == "16S-ITS") %>% pull(n)
```


16S-only (`r n_16S_top_10`) and 16S-ITS (`r n_16S_ITS_top_10`) models comprised the top 10 over all best performing models, as determined by lowest average MAE.

### Worst 10 overall performing models:

```{r, echo=FALSE}
mean_values %>%
  slice_max(order_by = MAE, n = 10) %>%
  knitr::kable(.)
```


### All 16S models ordered by MAE:

```{r, echo=FALSE}
# 16S only models
bact_summary <- mean_values %>%
  filter(taxonomy == "16S") %>%
  arrange(MAE)

knitr::kable(bact_summary)
```

16S models MAE ranged from `r round(min(bact_summary$MAE), 4)` to `r round(max(bact_summary$MAE), 4)`, with the top performing model the phylum level model with environmental parameters.

### All ITS models ordered by MAE:

```{r, echo=FALSE}
# ITS only models
mean_values %>%
  filter(taxonomy == "ITS") %>%
  arrange(MAE) %>%
  knitr::kable(.)
```

### All 16S-ITS models ordered by MAE:

```{r, echo=FALSE}
# 16S-ITS models
mean_values %>%
  filter(taxonomy == "16S-ITS") %>%
  arrange(MAE) %>%
  knitr::kable(.)
```

### Best 3 models for each biological marker

```{r, echo=FALSE}
top_3_for_each_marker <- mean_values %>%
  group_by(taxonomy) %>%
  slice_min(order_by = MAE, n = 3) 

top_mods <- mean_values %>%
  group_by(taxonomy) %>%
  slice_min(order_by = MAE, n = 1) %>%
  pull("model")
  
knitr::kable(top_3_for_each_marker)
```

The top models for each biological marker were `r top_mods[1]`, `r top_mods[2]`, and `r top_mods[3]`.

## Model Predictions

### `r top_mods[1]`

```{r, include=FALSE}
model_1_name <- top_mods[1]
model_1_idx <- which(names(all_rf_summary) %in% model_1_name)

model_1_opt_ranger <- all_rf_results[[model_1_idx]]@optimal_model_results$optimal_ranger

# train set accuracy
mod1_train_predictions_lm <- lm(all_rf_results[[model_1_idx]]@train_df$ADH_10_actual ~ predict(model_1_opt_ranger, all_rf_results[[model_1_idx]]@train_df)$predictions)
mod1_train_predictions_lm_aov <- anova(mod1_train_predictions_lm)

mod1_train_predictions <- ggplot(data = NULL,
       aes(x = predict(model_1_opt_ranger, all_rf_results[[model_1_idx]]@train_df)$predictions,
           y = all_rf_results[[model_1_idx]]@train_df$ADH_10_actual)) +
  geom_point(size = 1.5) +
  geom_smooth(method = "lm", color = 'red') +
  labs(x = "Predicted ADH",
       y = "Actual ADH") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  annotate("text",
           x = 2750,
           y = -600,
           label = paste0("Adj R2 = ", signif(summary(mod1_train_predictions_lm)$adj.r.squared, 3),
                 " Intercept = ", signif(mod1_train_predictions_lm$coefficients[[1]], 3), "\n",
                 " Slope = ", signif(mod1_train_predictions_lm$coefficients[[2]], 3),
                 " P = ", signif(summary(mod1_train_predictions_lm)$coefficients[2, 4], 3)),
           size = 2)

# test set accuracy
mod1_test_predictions_lm <- lm(all_rf_results[[model_1_idx]]@test_df$ADH_10_actual ~ predict(model_1_opt_ranger, all_rf_results[[model_1_idx]]@test_df)$predictions)

mod1_test_predictions <- ggplot(data = NULL,
       aes(x = predict(model_1_opt_ranger, all_rf_results[[model_1_idx]]@test_df)$predictions,
           y = all_rf_results[[model_1_idx]]@test_df$ADH_10_actual)) +
  geom_point(size = 1.5) +
  geom_smooth(method = "lm", color = 'blue') +
  labs(x = "Predicted ADH",
       y = "Actual ADH") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  annotate("text",
           x = 2500,
           y = -1000,
           label = paste0("Adj R2 = ", signif(summary(mod1_test_predictions_lm)$adj.r.squared, 3),
                 " Intercept = ", signif(mod1_test_predictions_lm$coefficients[[1]], 3), "\n",
                 " Slope = ", signif(mod1_test_predictions_lm$coefficients[[2]], 3),
                 " P = ", signif(summary(mod1_test_predictions_lm)$coefficients[2, 4], 3)),
           size = 2)
```

### `r top_mods[2]`

```{r, include=FALSE}
model_2_name <- top_mods[2]
model_2_idx <- which(names(all_rf_summary) %in% model_2_name)

model_2_opt_ranger <- all_rf_results[[model_2_idx]]@optimal_model_results$optimal_ranger

# train set accuracy
mod2_train_predictions_lm <- lm(all_rf_results[[model_2_idx]]@train_df$ADH_10_actual ~ predict(model_2_opt_ranger, all_rf_results[[model_2_idx]]@train_df)$predictions)


mod2_train_predictions <- ggplot(data = NULL,
       aes(x = predict(model_2_opt_ranger, all_rf_results[[model_2_idx]]@train_df)$predictions,
           y = all_rf_results[[model_2_idx]]@train_df$ADH_10_actual)) +
  geom_point(size = 1.5) +
  geom_smooth(method = "lm", color = 'red') +
  labs(x = "Predicted ADH",
       y = "Actual ADH") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  annotate("text",
           x = 2550,
           y = -600,
           label = paste0("Adj R2 = ", signif(summary(mod2_train_predictions_lm)$adj.r.squared, 3),
                 " Intercept = ", signif(mod2_train_predictions_lm$coefficients[[1]], 3), "\n",
                 " Slope = ", signif(mod2_train_predictions_lm$coefficients[[2]], 3),
                 " P = ", signif(summary(mod2_train_predictions_lm)$coefficients[2, 4], 3)),
           size = 2)

# test set accuracy
mod2_test_predictions_lm <- lm(all_rf_results[[model_2_idx]]@test_df$ADH_10_actual ~ predict(model_2_opt_ranger, all_rf_results[[model_2_idx]]@test_df)$predictions)

mod2_test_predictions <- ggplot(data = NULL,
       aes(x = predict(model_2_opt_ranger, all_rf_results[[model_2_idx]]@test_df)$predictions,
           y = all_rf_results[[model_2_idx]]@test_df$ADH_10_actual)) +
  geom_point(size = 1.5) +
  geom_smooth(method = "lm", color = 'blue') +
  labs(x = "Predicted ADH",
       y = "Actual ADH") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  annotate("text",
           x = 2250,
           y = -1200,
           label = paste0("Adj R2 = ", signif(summary(mod2_test_predictions_lm)$adj.r.squared, 3),
                 " Intercept = ", signif(mod2_test_predictions_lm$coefficients[[1]], 3), "\n",
                 " Slope = ", signif(mod2_test_predictions_lm$coefficients[[2]], 3),
                 " P = ", signif(summary(mod2_test_predictions_lm)$coefficients[2, 4], 3)),
           size = 2)
```


### `r top_mods[3]`

```{r, include=FALSE}
model_3_name <- top_mods[3]
model_3_idx <- which(names(all_rf_summary) %in% model_3_name)

model_3_opt_ranger <- all_rf_results[[model_3_idx]]@optimal_model_results$optimal_ranger

# train set accuracy
mod3_train_predictions_lm <- lm(all_rf_results[[model_3_idx]]@train_df$ADH_10_actual ~ predict(model_3_opt_ranger, all_rf_results[[model_3_idx]]@train_df)$predictions)


mod3_train_predictions <- ggplot(data = NULL,
       aes(x = predict(model_3_opt_ranger, all_rf_results[[model_3_idx]]@train_df)$predictions,
           y = all_rf_results[[model_3_idx]]@train_df$ADH_10_actual)) +
  geom_point(size = 1.5) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = "Predicted ADH",
       y = "Actual ADH") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  annotate("text",
           x = 2800,
           y = -400,
           label = paste0("Adj R2 = ", signif(summary(mod3_train_predictions_lm)$adj.r.squared, 3),
                 " Intercept = ", signif(mod3_train_predictions_lm$coefficients[[1]], 3), "\n",
                 " Slope = ", signif(mod3_train_predictions_lm$coefficients[[2]], 3),
                 " P = ", signif(summary(mod3_train_predictions_lm)$coefficients[2, 4], 3)),
           size = 2)


# test set accuracy
mod3_test_predictions_lm <- lm(all_rf_results[[model_3_idx]]@test_df$ADH_10_actual ~ predict(model_3_opt_ranger, all_rf_results[[model_3_idx]]@test_df)$predictions)

mod3_test_predictions <- ggplot(data = NULL,
       aes(x = predict(model_3_opt_ranger, all_rf_results[[model_3_idx]]@test_df)$predictions,
           y = all_rf_results[[model_3_idx]]@test_df$ADH_10_actual)) +
  geom_point(size = 1.5) +
  geom_smooth(method = "lm", color = 'blue') +
  labs(x = "Predicted ADH",
       y = "Actual ADH") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  annotate("text",
           x = 2600,
           y = -1200,
           label = paste0("Adj R2 = ", signif(summary(mod3_test_predictions_lm)$adj.r.squared, 3),
                 " Intercept = ", signif(mod3_test_predictions_lm$coefficients[[1]], 3), "\n",
                 " Slope = ", signif(mod3_test_predictions_lm$coefficients[[2]], 3),
                 " P = ", signif(summary(mod3_test_predictions_lm)$coefficients[2, 4], 3)),
           size = 2)

# ggarrange(mod3_train_predictions, mod3_test_predictions, legend.grob = dataset_legend)
```


```{r, echo=FALSE, message=FALSE}
# plot_grid(mod1_train_predictions, mod2_train_predictions, mod3_train_predictions, mod1_test_predictions, mod2_test_predictions, mod3_test_predictions, 
#           nrow = 2,
#           labels = c("A", "B", "C", "D", "E", "F"))
dataset <- data.frame(dataset = c("Train", "Test", "Train", "Test"), 
           val = c(2, 3, 5, 2))
dataset$dataset <- as.factor(dataset$dataset)
t <- ggplot(dataset) +
  aes(x = val, y = dataset, color = dataset) +
  scale_color_manual(values = c("Train" = 'red', "Test" = 'blue'),
                     drop = FALSE) +
  geom_point() +
  labs(color = "Data set") +
  theme(legend.position = "top")
dataset_legend <- get_legend(t)

ggarrange(mod1_train_predictions, mod2_train_predictions, mod3_train_predictions, mod1_test_predictions, mod2_test_predictions, mod3_test_predictions,
          nrow = 2,
          ncol = 3,
          labels = c("A", "B", "C", "D", "E", "F"),
          legend.grob = dataset_legend,
          legend = "top") 
```

```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig2.tiff"), units = "in", width = 7.5, height = 5.5, res = 300)
ggarrange(mod1_train_predictions, mod2_train_predictions, mod3_train_predictions, mod1_test_predictions, mod2_test_predictions, mod3_test_predictions,
          nrow = 2,
          ncol = 3,
          labels = c("A", "B", "C", "D", "E", "F"),
          legend.grob = dataset_legend,
          legend = "top") 
```

## MAE ~ biological marker

```{r, include=FALSE}
mae_marker <- lm(MAE ~ taxonomy, data = mean_values)
mae_marker_anova_p <- anova(mae_marker)
mae_marker_anova_p$`Pr(>F)`[1]

my_comparisons <- list( c("16S", "16S-ITS"), c("16S", "ITS"), c("16S-ITS", "ITS"))

tax_colors <- c("#395D9CFF", "#3497A9FF", "#60CEACFF")
names(tax_colors) <- c("16S", "16S-ITS", "ITS")

mae_marker_box <- ggplot(mean_values) +
  aes(x = taxonomy, y = MAE, fill = taxonomy) +
  geom_boxplot() +
  labs(x = "Biological Marker",
       y = "Average Mean Absolute Error (MAE)") +
  scale_fill_manual(values = tax_colors, guide = "none") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test", label = "p.format", label.y = c(1010, 1025, 1050)) +
  annotate("text",
           x = 1,
           y = 1070,
           label = paste0("ANOVA p = ", round(mae_marker_anova_p$`Pr(>F)`[1], 4)),
           size = 3) 

anova(mae_marker) %>% writexl::write_xlsx(., here::here("data/MAE_tax-marker_anova.xlsx"))
```

```{r, echo=FALSE}
mae_marker_box
```

```{r, include=FALSE}
rownames(mae_marker_anova_p)[1] <- "biologicalMarker"
kbl(mae_marker_anova_p,
    format = "latex",
    row.names = TRUE,
    # caption = "Model mean absoulte error (MAE) varies due to biological marker as reported by analysis of Variance (ANOVA). Model parameter biologicalMarker refers whether 16S, ITS, or both organisms were used in model construction.",
    digits = 3,
    booktabs = TRUE) %>% 
save_kable(here::here("figures/MAE_biologicalMarker_anova.pdf"), keep_tex = FALSE)
```

```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig3.tiff"), units = "in", width = 4, height = 4, res = 300)
mae_marker_box
dev.off()
```


## MAE ~ taxonomic level

```{r, include=FALSE}
mae_16S_tax_level <- filter(mean_values, taxonomy == "16S") %>% lm(MAE ~ tax_level, data = .)
anova(mae_16S_tax_level)$`Pr(>F)`[1]

mae_ITS_tax_level <- filter(mean_values, taxonomy == "ITS") %>% lm(MAE ~ tax_level, data = .)
anova(mae_ITS_tax_level)$`Pr(>F)`[1]

mae_mixed_tax_level <- filter(mean_values, taxonomy == "16S-ITS") %>% lm(MAE ~ tax_level, data = .)
anova(mae_mixed_tax_level)$`Pr(>F)`[1]

anova_dat <- data.frame(text = c(paste0("ANOVA p = ", round(anova(mae_16S_tax_level)$`Pr(>F)`[1], 3)),
                                 paste0("ANOVA p = ", round(anova(mae_mixed_tax_level)$`Pr(>F)`[1], 3)),
                                 paste0("ANOVA p = ", round(anova(mae_ITS_tax_level)$`Pr(>F)`[1], 3))),
                        taxonomy = c("16S", "16S-ITS", "ITS"),
                        y = c(1000, 1000, 1000)
                        )

my_comparisons <- list( c("Phylum", "Class"), c("Phylum", "Order"), c("Phylum", "OTU"), c("Class","Order"),c("Class","OTU"), c("Order","OTU") )

tax_colors <- c("#395D9CFF", "#3497A9FF", "#60CEACFF")
names(tax_colors) <- c("16S", "16S-ITS", "ITS")


mae_taxlevel_box <- ggplot(mean_values) +
  aes(x = factor(tax_level, ordered = TRUE, levels = c("Phylum", "Class", "Order", "OTU")), y = MAE, fill = taxonomy) +
  geom_boxplot() +
  labs(x = "Taxonomic Level",
       y = "Average Mean Absolute\n Error (MAE)") +
  facet_wrap(~ taxonomy) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white")) +
  scale_fill_manual(values = tax_colors, guide = "none") +
  geom_text(data = anova_dat,
            mapping = aes(x = 4, y = Inf, label = text, size = 12),
            hjust = 0.7,
            vjust = 2,
            size.unit = "pt") +
  scale_size(guide = 'none')
  

# only 16S-ITS Class and order and significantly different

mae_16S_tax_level <- filter(mean_values, taxonomy == "16S") %>% lm(MAE ~ tax_level, data = .)
anova(mae_16S_tax_level) %>% writexl::write_xlsx(., here::here("data/MAE_16S_taxlevel_anova.xlsx"))

mae_ITS_tax_level <- filter(mean_values, taxonomy == "ITS") %>% lm(MAE ~ tax_level, data = .)
anova(mae_ITS_tax_level) %>% writexl::write_xlsx(., here::here("data/MAE_ITS_taxlevel_anova.xlsx"))

mae_mixed_tax_level <- filter(mean_values, taxonomy == "16S-ITS") %>% lm(MAE ~ tax_level, data = .)
anova(mae_mixed_tax_level) %>% writexl::write_xlsx(., here::here("data/MAE_16S-ITS_taxlevel_anova.xlsx"))
```

```{r, echo=FALSE}
mae_taxlevel_box
```


```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig4.tiff"), units = "in", width = 6, height = 3.5, res = 300)
mae_taxlevel_box
dev.off()
```

## Model Features

### Top 25 important model features

```{r, include=FALSE, warning=FALSE}
get_top_25_features <- function(optimal_model, tax_table, tax_level) {

  top_25 <- optimal_model$variable.importance %>%
    tidy() %>%
    slice_max(order_by = x, n = 25)
  
  top_25_names <- top_25$names
  # print(top_25_names)
  
  top_25_tax <- tax_table[tax_table$OTU %in% top_25_names, ] %>%
    select(OTU, all_of(tax_level))
  colnames(top_25_tax) <- c("OTU", "tax")
  # return(top_25_tax)

  top_25 <- top_25 %>%
    left_join(top_25_tax, by = c("names" = "OTU")) %>%
    mutate(predictor = case_when(names == "EC_LRR" ~ "Electrical conductivity",
                                 names == "LAP_LRR" ~ "Leucine aminopeptidase",
                                 names == "pH_LRR" ~ "pH",
                                 names == "moisture" ~ "Soil moisture",
                                 names == "Temperature" ~ "Temperature",
                                 names == "PHOS_LRR" ~ "Alkaline phosphatase",
                                 names == "BG_LRR" ~ "$\\beta$-glucosidase",
                                 names == "NAG_LRR" ~ "N-acetyl-$\\beta$-D-glucoseaminidase",
                                 .default = tax),
           predictor_type = case_when(str_detect(names, "Otu") == TRUE ~ "16S",
                                      str_detect(names, "ITS") == TRUE ~ "ITS",
                                      TRUE ~ "Environmental"))

   return(top_25)
}


plot_top_25_features <- function(top_25_df) {
  top_25_df$predictor_type <- factor(top_25_df$predictor_type, levels = c("16S", "ITS", "Environmental"))
  
  colors <- brewer.pal(3, "Dark2")
  types <- factor(x = c("16S", "ITS", "Environmental"), levels = c("16S", "ITS", "Environmental"))
  names(colors) <- levels(types)
  

  top_25_plot <- top_25_df %>%
    ggplot(aes(reorder(predictor, x), x, fill = predictor_type)) +
    geom_col(show.legend = T) +
    coord_flip() + 
    scale_fill_manual(values = c("16S" = "#1B9E77", "ITS" = "#D95F02", "Environmental" = "#7570B3"), drop = FALSE) +
    scale_y_continuous(labels = function(x) format(x, scientific = TRUE),
                       expand = expansion(mult = c(0,0))) +
    labs(y = "variance in responses",
         x = "Predictor",
         fill = "Predictor type") +
    theme_bw() +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text.y = element_text(size = 6),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10),
          aspect.ratio = 1.9/2)

  top_25_plot
}
```

```{r, include=FALSE, warning=FALSE}
bact_phylum_tax_table <- read_excel(here("data/TOX2_16S_TSS_Phylum_taxtable.xlsx"))
top_bact_mod_features <- get_top_25_features(model_1_opt_ranger, bact_phylum_tax_table, "Phylum") |>
  plot_top_25_features()


bact_order_tax_table <- read_excel(here("data/TOX2_16S_TSS_Order_taxtable.xlsx"))
its_order_tax_table <- read_excel(here("data/TOX2_ITS_TSS_Order_taxtable.xlsx"))

combined_order_tax_table <- bind_rows(bact_order_tax_table, its_order_tax_table)
top_bact_ITS_mod_features <- get_top_25_features(model_2_opt_ranger, combined_order_tax_table, "Order") |>
  plot_top_25_features()

top_its_mod_features <- get_top_25_features(model_3_opt_ranger, its_order_tax_table, "Order") |>
  plot_top_25_features()
```

```{r, echo=FALSE}
ggarrange(top_bact_mod_features, top_its_mod_features, top_bact_ITS_mod_features,  nrow = 2, ncol = 2, labels = c("A", "B", "C"), align = "v", common.legend = TRUE)
```


```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig5.tiff"), units = "in", width = 7.5, height = 5.5, res = 300)
ggarrange(top_bact_mod_features, top_its_mod_features, top_bact_ITS_mod_features, nrow = 2, ncol = 2, labels = c("A", "B", "C"), align = "v", common.legend = TRUE)
dev.off()
```


### Taxon abundance for select top features

```{r, include=FALSE, warning=FALSE}
bact_phylum_env_top_features <- get_top_25_features(all_rf_results$bact_phylum_env@optimal_model_results$optimal_ranger, bact_phylum_tax_table, "Phylum")

bact_phylum_env_top_features

phyla_taxa <- c("Firmicutes", "Acidobacteria", "Proteobacteria", "Nitrospirae")

phyla_taxa_otus <- bact_phylum_env_top_features$names[which(bact_phylum_env_top_features$tax %in% taxa)]


######################################
######## load metadata ###############
######################################
treatments <- read_excel(here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/treatments_pub.xlsx"))
treatments$ADH=as.numeric(treatments$ADH)
treatments$Type=as.factor(treatments$Type)
treatments$Trt=as.factor(treatments$Trt)
treatments$Sample_Type=as.factor(treatments$Sample_Type)
treatments$Timepoint=as.factor(treatments$Timepoint)
treatments$Season=as.factor(treatments$Season)
treatments$Sector=as.factor(treatments$Sector)
treatments$Sex=as.factor(treatments$Sex)
treatments$BMI_level = factor(treatments$BMI_level, ordered = TRUE, levels = c("Underweight","Normal","Overweight","Obese"))

TOXdata = read_excel(here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/TOX_data_all_pub.xlsx"), sheet = "Data")

TOXdata = TOXdata %>% select("Sample","Temperature","ADH_10_actual", "Gravimetric Moisture","pH","pH_LRR","EC","EC_LRR","BG_avg","BG_LRR","NAG_avg","NAG_LRR","PHOS_avg","PHOS_LRR","LAP_avg", "LAP_LRR","Evolved_CO2","LRR_resp")

metadata = treatments %>%
  left_join(TOXdata, by = "Sample")

#prep metadata for phyloseq
map=metadata
head(map)
map=sample_data(map) #convert metadata into phyloseq format
rownames(map)=map$group #assign rownames to be group

levels=c("TOX001CON", "TOX001", "TOX001_1500", "TOX001_3000", "TOX001_4500", "TOX001_8000", "TOX001_11500", "TOX001_15500","TOX001DF", "TOX002CON", "TOX002", "TOX002_1500A", "TOX002_1500B", "TOX002_2750", "TOX002_3750","TOX002DF", "TOX003CON", "TOX003", "TOX003_1500", "TOX003_3000", "TOX003_4500","TOX003DF", "TOX004CON", "TOX004", "TOX004_1500", "TOX004_3000", "TOX004_3500","TOX004DF", "TOX005CON", "TOX005", "TOX005_1500", "TOX005_3000", "TOX005_4500", "TOX005_6500", "TOX005_8500","TOX005DF", "TOX006CON", "TOX006", "TOX006_1500", "TOX006_3000", "TOX006_4500","TOX006DF", "TOX007CON", "TOX007", "TOX007_1500", "TOX007_3000", "TOX007_4500", "TOX007_6000","TOX007DF", "TOX008CON", "TOX008", "TOX008_1500", "TOX008_3000", "TOX008_4500", "TOX008_6500","TOX008DF", "TOX009CON", "TOX009", "TOX009_1500", "TOX009_3000", "TOX009_4500","TOX009DF", "TOX010CON", "TOX010", "TOX010_1500", "TOX010_2500", "TOX010_4500", "TOX010_9000", "TOX010_13000", "TOX010_17500", "TOX010DF", "TOX011CON", "TOX011", "TOX011_1500", "TOX011_3000", "TOX011_3500", "TOX011_5500", "TOX011_7000", "TOX012CON", "TOX012", "TOX012_1500", "TOX012_3000", "TOX012_4000", "TOX012_6000","TOX012DF", "TOX013CON", "TOX013", "TOX013_1500", "TOX013_3000", "TOX013_4000", "TOX013_7500", "TOX013DF","TOX015CON","TOX015","TOX015_250","TOX015_500","TOX015_1000","TOX015_1500", "TOX016CON","TOX016","TOX016_500","TOX016_1000","TOX016_1500","TOX016DF","TOX017CON","TOX017","TOX017_1500","TOX017_3000","TOX017_4500","TOX017_8500","TOX017_13000","TOX017_18500","TOX017DF","TOX018CON","TOX018","TOX018_1500","TOX018_2000","TOX018_3000","TOX018_4000", "TOX019CON","TOX019","TOX019_1500","TOX019_3000","TOX019_3500","TOX019_4500","TOX019_5500","TOX019DF","TOX020CON","TOX020","TOX020_1500","TOX020_3500","TOX020_4500","TOX020_6000","TOX020DF")
map$group=ordered(map$group, levels=levels)


#####################################################
#### obtain 16S OTU tables from phyloseq object #####
######################################################
mothur_16S_data = import_mothur(mothur_shared_file = here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/TOX2_16S.shared"), mothur_constaxonomy_file = here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/TOX2_16S.taxonomy"))
moth_merge = merge_phyloseq(mothur_16S_data, map) #merge mothurdata with the metadata
colnames(tax_table(moth_merge)) #print column names of tax file
colnames(tax_table(moth_merge)) = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus") #rename tax column names

moth_sub = subset_samples(moth_merge, Type == "sample") #remove check samples
moth_decomp = subset_samples(moth_sub, Trt == "donor") #remove fluid samples and control soil samples
moth_decomp = subset_samples(moth_decomp, group != "TOX002_1500A") #remove TOX002-1500
moth_decomp = subset_samples(moth_decomp, group != "TOX002_1500B") #remove TOX002-1500
moth_decomp_5000 = subset_samples(moth_decomp, ADH_10_actual < 5000)

phylum_abundance <- moth_decomp_5000 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x / sum(x)}) %>%
  psmelt() %>%
  filter(Phylum %in% phylum_taxa) %>%
  select(Donor, ADH, ADH_10_actual, OTU, Phylum, Abundance) 
  # %>%
  # pivot_wider(names_from = OTU, values_from = Abundance)

phylum_plot <- phylum_abundance %>%
  ggplot() +
  aes(x = ADH_10_actual, y = Abundance, color = Donor) +
  geom_point() +
  # geom_line(na.rm = TRUE) +
  scale_color_manual(values = colpalette2) +
  labs(x = "Accumulated Degree Hours",
       y = "Relative Abundance") +
  theme_bw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white")) +
  theme(legend.position = "bottom",
        legend.title.position = "top") + 
  guides(color = guide_legend(override.aes = list(size = 0.5))) +
  guides(color = guide_legend(ncol = 10, byrow = TRUE))  +
  theme(legend.title = element_text(size = 8), 
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.1, "lines")) +
  facet_wrap(~ Phylum, scales = "free_y")

```

```{r, echo=FALSE, warning=FALSE}
phylum_plot 
```

```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig6.tiff"), units = "in", width = 7.5, height = 5.5, res = 300)
phylum_plot
```

```{r, include=FALSE, warning=FALSE}
its_order_noenv_top_features <- get_top_25_features(all_rf_results$ITS_order_noenv@optimal_model_results$optimal_ranger, its_order_tax_table, "Order")

its_order_noenv_top_features

taxa <- c("o__Pleosporales")

taxa_otus <- its_order_noenv_top_features$names[which(its_order_noenv_top_features$tax %in% taxa)]



######################################
######## load metadata ###############
######################################
treatments <- read_excel(here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/treatments_pub.xlsx"))
treatments$ADH=as.numeric(treatments$ADH)
treatments$Type=as.factor(treatments$Type)
treatments$Trt=as.factor(treatments$Trt)
treatments$Sample_Type=as.factor(treatments$Sample_Type)
treatments$Timepoint=as.factor(treatments$Timepoint)
treatments$Season=as.factor(treatments$Season)
treatments$Sector=as.factor(treatments$Sector)
treatments$Sex=as.factor(treatments$Sex)
treatments$BMI_level = factor(treatments$BMI_level, ordered = TRUE, levels = c("Underweight","Normal","Overweight","Obese"))

TOXdata = read_excel(here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/TOX_data_all_pub.xlsx"), sheet = "Data")

TOXdata = TOXdata %>% select("Sample","Temperature","ADH_10_actual", "Gravimetric Moisture","pH","pH_LRR","EC","EC_LRR","BG_avg","BG_LRR","NAG_avg","NAG_LRR","PHOS_avg","PHOS_LRR","LAP_avg", "LAP_LRR","Evolved_CO2","LRR_resp")

metadata = treatments %>%
  left_join(TOXdata, by = "Sample")

#prep metadata for phyloseq
map=metadata
head(map)
map=sample_data(map) #convert metadata into phyloseq format
rownames(map)=map$group #assign rownames to be group

levels=c("TOX001CON", "TOX001", "TOX001_1500", "TOX001_3000", "TOX001_4500", "TOX001_8000", "TOX001_11500", "TOX001_15500","TOX001DF", "TOX002CON", "TOX002", "TOX002_1500A", "TOX002_1500B", "TOX002_2750", "TOX002_3750","TOX002DF", "TOX003CON", "TOX003", "TOX003_1500", "TOX003_3000", "TOX003_4500","TOX003DF", "TOX004CON", "TOX004", "TOX004_1500", "TOX004_3000", "TOX004_3500","TOX004DF", "TOX005CON", "TOX005", "TOX005_1500", "TOX005_3000", "TOX005_4500", "TOX005_6500", "TOX005_8500","TOX005DF", "TOX006CON", "TOX006", "TOX006_1500", "TOX006_3000", "TOX006_4500","TOX006DF", "TOX007CON", "TOX007", "TOX007_1500", "TOX007_3000", "TOX007_4500", "TOX007_6000","TOX007DF", "TOX008CON", "TOX008", "TOX008_1500", "TOX008_3000", "TOX008_4500", "TOX008_6500","TOX008DF", "TOX009CON", "TOX009", "TOX009_1500", "TOX009_3000", "TOX009_4500","TOX009DF", "TOX010CON", "TOX010", "TOX010_1500", "TOX010_2500", "TOX010_4500", "TOX010_9000", "TOX010_13000", "TOX010_17500", "TOX010DF", "TOX011CON", "TOX011", "TOX011_1500", "TOX011_3000", "TOX011_3500", "TOX011_5500", "TOX011_7000", "TOX012CON", "TOX012", "TOX012_1500", "TOX012_3000", "TOX012_4000", "TOX012_6000","TOX012DF", "TOX013CON", "TOX013", "TOX013_1500", "TOX013_3000", "TOX013_4000", "TOX013_7500", "TOX013DF","TOX015CON","TOX015","TOX015_250","TOX015_500","TOX015_1000","TOX015_1500", "TOX016CON","TOX016","TOX016_500","TOX016_1000","TOX016_1500","TOX016DF","TOX017CON","TOX017","TOX017_1500","TOX017_3000","TOX017_4500","TOX017_8500","TOX017_13000","TOX017_18500","TOX017DF","TOX018CON","TOX018","TOX018_1500","TOX018_2000","TOX018_3000","TOX018_4000", "TOX019CON","TOX019","TOX019_1500","TOX019_3000","TOX019_3500","TOX019_4500","TOX019_5500","TOX019DF","TOX020CON","TOX020","TOX020_1500","TOX020_3500","TOX020_4500","TOX020_6000","TOX020DF")
map$group=ordered(map$group, levels=levels)


#####################################################
#### obtain 16S OTU tables from phyloseq object #####
######################################################
mothur_ITS_data = import_mothur(mothur_shared_file = here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/TOX2_ITS.shared"), mothur_constaxonomy_file = here("../Mason_SoilMicrobialEcology-Decomp-BMI_mSphere_2022/TOX2_ITS.taxonomy"))
moth_ITS_merge = merge_phyloseq(mothur_ITS_data, map) #merge mothurdata with the metadata
colnames(tax_table(moth_ITS_merge)) #print column names of tax file
colnames(tax_table(moth_ITS_merge)) = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species") #rename tax column names

moth_ITS_sub = subset_samples(moth_ITS_merge, Type == "sample") #remove check samples
moth_ITS_decomp = subset_samples(moth_ITS_sub, Trt == "donor") #remove fluid samples and control soil samples
moth_ITS_decomp = subset_samples(moth_ITS_decomp, group != "TOX002_1500A") #remove TOX002-1500
moth_ITS_decomp = subset_samples(moth_ITS_decomp, group != "TOX002_1500B") #remove TOX002-1500
moth_ITS_decomp_5000 = subset_samples(moth_ITS_decomp, ADH_10_actual < 5000)

pleo_abundance <- moth_ITS_decomp_5000 %>%
  tax_glom(taxrank = "Order") %>%
  transform_sample_counts(function(x) {x / sum(x)}) %>%
  psmelt() %>%
  filter(Order %in% taxa) %>%
  select(Donor, ADH, ADH_10_actual, OTU, Order, Abundance) 
  # %>%
  # pivot_wider(names_from = OTU, values_from = Abundance)

pleo_plot <- pleo_abundance %>%
  ggplot() +
  aes(x = ADH_10_actual, y = Abundance, color = Donor) +
  geom_point() +
  # geom_line(na.rm = TRUE) +
  scale_color_manual(values = colpalette2) +
  labs(x = "Accumulated Degree Hours",
       y = "Relative Abundance") +
  theme_bw() +
  # theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  theme(legend.position = "bottom",
        legend.title.position = "top") + 
  guides(color = guide_legend(override.aes = list(size = 0.5))) +
  guides(color = guide_legend(ncol = 6, byrow = TRUE))  +
  theme(legend.title = element_text(size = 8), 
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.1, "lines"))

```


```{r, echo=FALSE, warning=FALSE}
pleo_plot + labs(title = "*Pleosporales* relative abundance")
```

```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/Fig7.tiff"), units = "in", width = 4.5, height = 3.5, res = 300)
pleo_plot
```

```{r, include = FALSE}
order_taxa <- c("Lactobacillales", "Bacteroidales", "Cardiobacteriales", "Clostridiales")

order_abundance <- moth_decomp_5000 %>%
  tax_glom(taxrank = "Order") %>%
  transform_sample_counts(function(x) {x / sum(x)}) %>%
  psmelt() %>%
  filter(Order %in% order_taxa) %>%
  select(Donor, ADH, ADH_10_actual, OTU, Order, Abundance) 
  # %>%
  # pivot_wider(names_from = OTU, values_from = Abundance)

order_plot <- order_abundance %>%
  ggplot() +
  aes(x = ADH_10_actual, y = Abundance, color = Donor) +
  geom_point() +
  # geom_line(na.rm = TRUE) +
  scale_color_manual(values = colpalette2) +
  labs(x = "Accumulated Degree Hours",
       y = "Relative Abundance") +
  theme_bw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white")) +
  theme(legend.position = "bottom",
        legend.title.position = "top") + 
  guides(color = guide_legend(override.aes = list(size = 0.5))) +
  guides(color = guide_legend(ncol = 10, byrow = TRUE))  +
  theme(legend.title = element_text(size = 8), 
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.1, "lines")) +
  facet_wrap(~ Order, scales = "free_y")
```

```{r, echo = FALSE}
order_plot
```

```{r, include=FALSE, eval=FALSE}
tiff(here::here("figures/S1Fig.tiff"), units = "in", width = 7.5, height = 5.5, res = 300)
order_plot
```
